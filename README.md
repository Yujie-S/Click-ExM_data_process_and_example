# Click-ExM data process and example
Matlab code and example files for manuscript *Click-ExM enables expansion microscopy for all biomolecules, by De-en Sun, et al*.

Last edited by Yujie Shi (yujieshi@scripps.edu) Oct-06-2020.

## Introduction
The script `Process_click_EXM.m` in this repo is created for expansion microscopy data processing. This includes rigid registration, calculation of expansion factor, 
B-spline non-rigid registration, calculation of distortion field and RMS error. For detailed explanation of the code, see the annotations inside the script. 
All dependencies (`registerImages.m`, `nr_registerImages.m`, `RMSE_cal.m`, and `RMSE_MS.m`) are included in this repo. The code was written and used under *Matlab R2018a*.

## Description of the method
#### Rigid registration and expansion factor calculation
The pre-expansion images were first stretched by a scaling factor *F<sub>esti</sub>* of 3.8~4.3 with bicubic interpolation to approximately 
match the scale of the post-expansion images. 
This estimated expansion factor was decided based on the macroscopic measurement of gel size. 
The stretched pre-expansion image was used as the ‘fixed image’ for rigid registration, and the post-expansion images as the ‘moving image’. 
Rigid registration was performed using the monomodal intensity-based registration with `imregtform` function. 
Affine transformation was used in the function to correct the shear deformation of the gel. 
The *X-* and *Y-* scaling elements (*x<sub>corr</sub>* and *y<sub>corr</sub>*) in the transformation matrix calculated by the imregtform function were used to correct the rough 
scaling factor (*F<sub>esti</sub>*). 
The final corrected expansion factor (*F<sub>corr</sub>*) was therefore calculated as 
*F<sub>corr</sub>* = *F<sub>esti</sub>*&times;&radic;(*x<sub>corr</sub>*&times;*y<sub>corr</sub>*)
#### Non-rigid B-spline registration and distortion analysis
The registered pre- and post-expansion images were then subjected to B-spline non-rigid registration. 
To exclude regions with no features, masks of the rigid registered pre- and post-expansion images were generated by Gaussian blur to suppress the background. 
The displacement field and B-spline registered images were then acquired with the `imregdemons` function, 
and the distortion vector field was visualized with the `quiver` function. 
RMSE was quantified by calculating the difference of distance between each pair of matching features before and after B-spline registration, 
and plotted as a function of the distance between the matching features.

## Instruction for use
- Download the 
